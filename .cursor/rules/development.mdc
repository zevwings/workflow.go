---
description: 开发规范与指南，包含代码风格、错误处理、测试规范、Git 工作流和代码审查
type: always
---

# 开发规范与指南

---

## 项目概述

这是一个用 Go 编写的 CLI 工具，用于自动化开发工作流，提供 PR 管理、Jira 集成、日志处理等功能。

### 架构设计

项目采用分层架构：
- **CLI 入口层** (`cmd/workflow/main.go`): 命令行入口和初始化
- **命令定义层** (`internal/cli/`): CLI 根命令定义和命令注册
- **命令实现层** (`internal/commands/`): CLI 命令实现，处理用户交互
- **核心业务逻辑层** (`internal/lib/`): 所有业务逻辑实现
- **工具函数层** (`internal/utils/`): 通用工具函数

详细的模块架构信息请参考 `docs/architecture/architecture.md`。

## 开发规范与指南

**重要**：所有开发规范和指南请严格遵循 `docs/guidelines/development/` 目录中的详细说明。

### 开发规范引用

**必须遵守的开发规范文档**：`docs/guidelines/development/README.md`（开发规范索引）

该目录包含完整的开发规范，包括：
- **核心规范**：代码风格、错误处理、命名规范、模块组织
- **流程规范**：Git 工作流、提交规范、代码审查
- **参考文档**：日志、文档、配置管理、安全性、依赖管理、性能优化、开发工具等

### 快速参考

以下是最常用的规范快速参考（**详细说明和完整规范请查看 `docs/guidelines/development/README.md`**）：

- **代码格式化**：`go fmt` 或 `gofmt`（提交前必须运行）
- **代码检查**：`golangci-lint run`（所有警告必须修复）
- **命名约定**：包名 `lowercase`，公开函数/变量 `PascalCase`（首字母大写），私有函数/变量 `camelCase`（首字母小写），类型/接口 `PascalCase`，常量推荐使用 `PascalCase`（如 `MaxRetries`），也可使用 `SCREAMING_SNAKE_CASE`（如 `MAX_RETRIES`）
- **导入顺序**：标准库 → 第三方库 → 项目内部（使用 `goimports` 自动排序）
- **错误处理**：使用 Go 的 `error` 接口，使用 `fmt.Errorf` 或 `errors.Wrap` 为错误消息添加上下文
- **文档注释**：所有公共 API 必须有 `//` 文档注释（以函数/类型名开头），包含参数、返回值、错误、示例

### 🚫 代码修改规则（强制执行）

**核心原则**：**默认禁止生成或修改代码**。除非用户使用明确的关键词请求，否则一律不生成或修改任何代码文件。

#### ⚡ 快速决策树（执行前必读）

**生成/修改代码前的快速检查**（必须按顺序执行，任何一步失败都必须立即停止）：

1. **白名单检查**（必须通过）
   - ❓ 用户消息包含 "生成代码"、"创建代码"、"写代码"、"实现"、"修改代码"、"更新代码"、"添加功能"、"修复bug"、"优化代码" 等白名单关键词？
   - ❌ **否** → **立即停止**，改为聊天文本响应或询问
   - ✅ **是** → 继续下一步

2. **黑名单检查**（必须通过）
   - ❓ 用户消息包含 "分析"、"总结"、"检查"、"诊断"、"排查"、"查看"、"讨论"、"审查"、"review" 等黑名单关键词？
   - ✅ **是** → **立即停止**，改为聊天文本响应（🚨 **这些词是黑名单，禁止生成/修改代码！**）
   - ❌ **否** → 继续下一步

3. **二次确认**（必须通过）
   - ❓ 询问用户："准备生成/修改以下代码：[文件路径或新文件说明]，修改内容：[简要说明]，确认要生成/修改吗？"
   - ✅ **用户明确确认**（回复"是"、"确认"、"可以"等） → 继续下一步
   - ❌ **用户未确认或拒绝** → **立即停止**，改为聊天文本响应

4. **生成/修改代码**
   - ✅ 只有通过所有步骤才能到达这里
   - 生成/修改代码到指定文件

**🚨 关键警告**：
- **"分析"、"总结"、"检查"、"讨论"、"审查"** 等词是**黑名单关键词**，看到这些词必须**禁止生成/修改代码**
- 这些词只能触发**聊天文本响应**或**询问**，不能直接生成/修改代码
- **任何 STOP 都必须立即停止**，不能继续执行后续步骤
- **不能跳过任何检查**，必须按顺序执行
- **不能"先生成再解释"**，必须在生成前通过所有检查
- **即使是白名单关键词，也必须执行步骤3（二次确认）**

#### 🔄 每次消息独立判断规则

**关键原则**：每个用户消息都必须**独立**评估代码生成/修改资格。同一聊天会话中之前的代码生成**不会**授予后续自动生成的权限。

**规则**：
- ✅ **每条消息**：必须独立通过全部检查
- ❌ **禁止假设**："用户之前想要代码，所以现在也想要"
- ❌ **禁止延续**："我之前生成了代码，所以继续生成"
- ✅ **始终检查**：**这条**特定消息是否包含明确关键词？

#### ✅ 允许生成/修改代码的情况（白名单）

**只有**用户使用以下明确关键词时才能生成或修改代码：

**直接指令**：
- "生成代码"、"创建代码"、"写代码"、"实现"
- "修改代码"、"更新代码"、"改写"、"重构"
- "添加功能"、"实现功能"、"完成功能"
- "修复bug"、"修复问题"、"解决错误"
- "优化代码"、"改进代码"

**明确要求**：
- "帮我实现..."
- "能否添加..."
- "请修改..."
- "需要完成..."

**⚠️ 重要**：如果用户没有使用上述关键词，**一律不生成或修改代码**！

#### ❌ 禁止自动生成/修改代码的场景（黑名单）

以下场景**严格禁止**自动生成或修改代码，只能在聊天中提供文本响应或询问：

**分析类请求**：
- "分析..."、"分析一下..."、"查看..."、"检查..."、"诊断..."、"排查..."
- ❌ 错误做法：自动生成或修改代码
- ✅ 正确做法：在聊天中提供分析结果，询问"需要我实现修复吗？"

**总结类请求**：
- "总结..."、"汇总..."、"概括..."、"梳理..."
- ❌ 错误做法：自动生成代码
- ✅ 正确做法：在聊天中提供总结文本

**讨论类请求**：
- "讨论..."、"说说..."、"解释..."、"说明..."
- ❌ 错误做法：自动生成代码
- ✅ 正确做法：在聊天中提供说明

**审查类请求**：
- "审查..."、"review..."、"检视..."、"看看..."
- ❌ 错误做法：自动修改代码
- ✅ 正确做法：在聊天中提供审查意见，询问"需要我修复这些问题吗？"

#### 📝 代码生成规范

生成代码时必须严格遵循 `docs/guidelines/development/` 目录中的所有开发规范，包括：

- **代码风格**：遵循项目的命名约定和代码风格，使用 `go fmt` 或 `gofmt` 格式化，通过 `golangci-lint` 检查
- **错误处理**：使用 Go 的 `error` 接口，使用 `fmt.Errorf` 或 `errors.Wrap` 为错误消息添加上下文，考虑所有错误情况
- **文档注释**：为新功能添加完整的文档注释（以函数/类型名开头，包含参数、返回值、错误、示例）
- **文档编写**：如果生成文档，必须参考 `docs/guidelines/document.md` 选择合适的模板，并在文档末尾添加"最后更新"时间戳（参考 `docs/guidelines/document.md` 中的"文档时间戳维护"章节）
- **API 设计**：遵循公共 API 设计原则，保持向后兼容性，使用注释标记废弃的 API（如 `// Deprecated: ...`），详细规范请参考 `docs/guidelines/development/references/documentation.md` 中的文档规范章节
- **模块组织**：遵循分层架构，正确组织包和依赖关系
- **测试**：为新功能添加单元测试和集成测试（如适用），测试文件以 `_test.go` 结尾
- **提交规范**：如果涉及 Git 提交，遵循 Conventional Commits 格式
- **代码质量**：保持代码简洁和可读性，遵循 Go 最佳实践（如使用 `error` 接口、避免 `panic`、处理所有错误等）
- **代码审查**：确保代码符合审查清单要求

### 🔒 规则优先级和执行保证

**优先级顺序**（从高到低）：
1. **遵守规则**（最高优先级）- 规则是绝对约束，不是建议
2. **用户明确请求** - 只有在用户明确要求时才执行操作，**即使是白名单关键词，也必须先询问用户确认**
3. **完成任务** - 在遵守规则的前提下完成任务

**执行保证**：
- 必须严格按照快速决策树执行，不能跳过任何检查
- 每次生成/修改代码前必须独立判断，不能基于上下文假设
- 如果检测到违规，必须立即纠正（撤销代码修改，承认错误）

### 📝 文档编写规范

**详细指南**：请参考 `docs/guidelines/document.md`（完整文档编写指南，包含文档时间戳维护章节）

#### 模板类型快速参考

项目提供 8 种文档模板，根据文档类型选择合适的模板：

1. **架构文档模板** (`architecture.template`) - 适用于：模块架构文档（同时包含 Lib 层和 Commands 层）
2. **指南文档模板** (`guideline.template`) - 适用于：开发规范、配置指南、使用指南等指南类文档
3. **需求文档模板** (`requirement.template`) - 适用于：待办事项、需求分析、实施计划等需求类文档
4. **检查工作流文档模板** (`review-workflow.template`) - 适用于：检查工作流文档（AI 工作流文档）
5. **检查指南模板** (`review-guide.template`) - 适用于：专门检查指南和快速参考文档
6. **核心规范文档模板** (`development-core.template`) - 适用于：核心开发规范文档（日常必读）
7. **开发工作流文档模板** (`development-workflow.template`) - 适用于：开发工作流文档（AI 工作流文档）
8. **参考文档模板** (`development-reference.template`) - 适用于：开发规范参考文档（详细指南）

**详细选择流程**：参考 `docs/guidelines/document.md` 中的完整模板选择流程图

#### 时间戳格式规范（必须）

**所有文档必须在末尾添加时间戳**，格式如下：

```markdown
---

**最后更新**: YYYY-MM-DD
```

**格式要求**：
- ✅ 使用英文冒号 `:` 和空格（不是中文冒号 `：`）
- ✅ 日期格式：`YYYY-MM-DD`（ISO 8601 标准）
- ✅ 位置：文档最末尾，分隔线 `---` 之后
- ❌ 错误格式：`**最后更新：**`（中文冒号）、`12/18/2025`（错误日期格式）

**获取当前日期**：
- Unix/macOS/Linux：`date +%Y-%m-%d`
- Windows PowerShell：`Get-Date -Format "yyyy-MM-dd"`

**详细说明**：参考 `docs/guidelines/document.md` 中的"文档时间戳维护"章节，包含完整格式规范、维护流程和最佳实践

#### 文档编写检查清单

生成文档时必须检查：
- [ ] 选择了正确的模板类型
- [ ] 文档结构符合模板要求（必选章节、推荐章节）
- [ ] 文档末尾添加了正确格式的时间戳
- [ ] 使用了统一的 emoji 图标和格式
- [ ] 目录链接与实际章节标题一致

**完整检查清单**：参考 `docs/guidelines/document.md` 中的章节检查清单

### 添加新功能

1. 在 `internal/lib/` 中实现核心业务逻辑
2. 在 `internal/commands/` 中添加 CLI 命令实现
3. 在 `internal/cli/root.go` 中注册命令
4. 添加测试用例（参考测试规范），测试文件以 `_test.go` 结尾
5. 更新文档
6. **扩展 PR 平台支持**：如需添加新的 PR 平台（如 GitLab、Bitbucket），参考 `docs/guidelines/pr-platform.md`

### Git 工作流和提交规范

**必须遵循**：`docs/guidelines/development/git-workflow.md` 和 `docs/guidelines/development/commit.md` 中的 Git 工作流和提交规范。

- **分支策略**：使用 `feature/*`、`fix/*`、`hotfix/*` 分支
- **提交格式**：使用 Conventional Commits 格式（`<type>(<scope>): <subject>`）
- **提交类型**：`feat`、`fix`、`docs`、`style`、`refactor`、`test`、`chore`、`perf`、`ci`
- **提交信息要求**：主题行不超过 50 个字符，使用祈使语气

### 测试规范

**详细规范**：请参考 `docs/guidelines/development/README.md` 和 `docs/guidelines/testing/README.md`。

- 单元测试放在对应包的 `_test.go` 文件中（如 `config_test.go`）
- 集成测试放在 `tests/` 目录或单独的测试包中
- 使用 `go test` 运行测试
- 目标覆盖率：> 80%，关键业务逻辑：> 90%

### 代码审查

**审查清单**：请参考 `docs/guidelines/development/code-review.md` 中的代码审查规范。

**代码审查工作流**：
- **提交前检查**（5-15分钟）：参考 `docs/guidelines/development/workflows/pre-commit.md`
- **综合深入检查**（2-4小时）：参考 `docs/guidelines/development/workflows/review.md`（功能完成后、定期审查、重大重构前）

提交 PR 前，确保：
- [ ] 代码已格式化（`go fmt` 或 `gofmt`）
- [ ] 通过 Lint 检查（`golangci-lint run`）
- [ ] 所有测试通过（`go test`）
- [ ] 添加了必要的文档注释
- [ ] 遵循了错误处理规范
- [ ] 提交信息符合规范

### 依赖管理

**详细原则**：请参考 `docs/guidelines/development/references/dependency-management.md` 中的依赖管理规范。

- 使用 `go get <package-name>` 或 `go mod tidy` 添加依赖
- 优先使用稳定版本的包
- 避免不必要的依赖
- 添加新依赖前，考虑是否真的需要、是否有更轻量的替代方案

### 开发工具

**必需工具和常用命令**：请参考 `docs/guidelines/development/references/development-tools.md` 中的开发工具规范（如已创建）。

**CI/CD 配置**：
- **CI 工作流配置**：参考 `docs/guidelines/ci-workflow.md`
- **GitHub 配置**：参考 `docs/guidelines/github-setup.md`（Secrets、Variables、分支保护规则等）

**性能分析工具**：
- **二进制大小分析**：使用 `go tool nm` 或 `go build -ldflags="-s -w"` 优化二进制大小
- **性能分析**：使用 `go tool pprof` 进行性能分析

安装开发工具：`make setup`

## 注意事项

1. **跨平台支持**：项目支持 macOS、Linux、Windows，注意平台特定代码。平台特定代码的组织方式和测试要求，请参考 `docs/guidelines/development/module-organization.md`（平台特定代码组织章节）
2. **配置文件**：配置文件存储在 `~/.workflow/config/workflow.toml`（macOS/Linux）或 `%APPDATA%\workflow\config\workflow.toml`（Windows）
3. **错误处理**：所有错误都应该提供清晰的错误消息和上下文，使用 `fmt.Errorf` 或 `errors.Wrap` 添加上下文
4. **日志**：使用 `logrus` 或标准库 `log` 进行日志记录，支持不同日志级别
5. **GitHub 配置**：首次设置项目时，需要配置 GitHub Secrets、Variables 和分支保护规则，参考 `docs/guidelines/github-setup.md`
6. **Go 版本**：项目要求 Go 1.21 或更高版本

---

**最后更新**: 2025-12-28
